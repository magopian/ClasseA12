<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Classe Ã  12</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./css/bulma.min.css">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
  <script src="app.js"></script>
  <script>
    const app = Elm.Main.init({ flags: {} });

    // Parse a rss xml content into a list of videos
    app.ports.parseRSS.subscribe(function (data) {

      const domParser = new DOMParser()
      const doc = domParser.parseFromString(data, "text/xml")
      const items = doc.querySelectorAll("item");
      const videoList = Array.prototype.slice.call(items).map(item => {
        const children = Array.prototype.slice.call(item.childNodes);
        let itemData = {};
        children.forEach(child => {
          if (child.nodeName === "media:content") {
            const mediaChildren = Array.prototype.slice.call(child.childNodes);
            mediaChildren.forEach(mediaChild => {
              if (mediaChild.nodeName === "media:thumbnail") {
                itemData["thumbnail"] = mediaChild.getAttribute("url");
              } else if (mediaChild.nodeName === "media:link") {
                itemData["link"] = mediaChild.getAttribute("url");
              } else if (mediaChild.nodeName === "media:player") {
                itemData["player"] = mediaChild.getAttribute("url");
              }
            })
          } else {
            itemData[child.nodeName] = child.textContent;
          }
        });
        return itemData;
      });
      app.ports.parsedVideoList.send(videoList);
    });

    // A video was selected in the file input, return its object URL so it can be set as a `src` attribute on a video element
    app.ports.videoSelected.subscribe(function (nodeID) {
      const fileInput = document.getElementById(nodeID);
      if (fileInput === null) {
        console.error("Didn't find a file input with id", nodeID);
        return;
      }
      const file = fileInput.files[0];
      const videoObjectUrl = URL.createObjectURL(file);
      app.ports.videoObjectUrl.send(videoObjectUrl);
    });

    // A new video record has been created, upload the selected video file as an attachment
    app.ports.submitVideo.subscribe(function ([nodeID, recordID]) {
      const fileInput = document.getElementById(nodeID);
      if (fileInput === null) {
        console.error("Didn't find a file input with id", nodeID);
        return;
      }
      const file = fileInput.files[0];
      // Create a multipart form
      var formData = new FormData();
      // Multipart attachment
      formData.append('attachment', file, file.name);
      // Post form using GlobalFetch API
      var url = `https://kinto.agopian.info/v1/buckets/classea12/collections/upcoming/records/${recordID}/attachment`;
      fetch(url, { method: "POST", body: formData, headers: { Authorization: "Basic " + btoa("classea12:notasecret") } })
        .then(function (result) {
          if (result.status >= 400) {
            throw new Error('Failed');
          }
          app.ports.videoSubmitted.send(result);
        })
        .catch(function (error) {
          console.error("Failed to upload attachment", error.toString());
        });
    });
  </script>
</body>

</html>